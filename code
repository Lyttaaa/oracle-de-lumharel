import discord
from discord.ext import commands
import json
from datetime import date

intents = discord.Intents.default()
intents.members = True
intents.reactions = True
bot = commands.Bot(command_prefix="!", intents=intents)

# --- CONFIGURATION ---

# IDs des messages des autels
AUTEL_MESSAGES = {
    "Orrak": 1353249202523865153,   # ID du message dâ€™autel Orrak
    "Vaek": 1353255384948801637,    # ID du message dâ€™autel Vaek
    "Nhyara": 1353255533544734751,  # ID du message dâ€™autel Nhyara
    "Zeroth": 1353255680462819450,  # ID du message dâ€™autel Zeroth
    "AÃ«ldis": 1353257057679052910   # ID du message dâ€™autel AÃ«ldis
}

# PriÃ¨res (emoji â†’ rÃ´le donnÃ©)
PRIERES = {
    "ğŸŒ¿": "BÃ©niÂ·e par la Terre",   # Orrak
    "ğŸ”¥": "MarquÃ©Â·e par la Flamme",  # Vaek
    "ğŸŒªï¸": "GuidÃ©Â·e par les Vents",  # Nhyara
    "ğŸŒ‘": "VoilÃ©Â·e par les Ombres",  # Zeroth
    "â„ï¸": "PortÃ©Â·e par le Silence"   # AÃ«ldis
}

# Offrandes (dieu â†’ liste dâ€™emojis acceptÃ©s)
OFFRANDES = {
    "Orrak": ["ğŸƒ", "ğŸŒ°", "ğŸ„", "ğŸ‚"],
    "Vaek": ["ğŸ§¨", "ğŸ”¨", "ğŸ”§", "ğŸ§±"],
    "Nhyara": ["ğŸ’¨", "ğŸ", "ğŸŒ¬ï¸", "ğŸ’«"],
    "Zeroth": ["âš°ï¸", "ğŸ•¸ï¸", "ğŸ–¤", "ğŸ—ï¸"],
    "AÃ«ldis": ["â˜ƒï¸", "ğŸ§Š", "ğŸŒ™", "â˜ï¸"]
}

# Valeur fixe des Lumes par offrande
LUMES_PAR_OFFRANDE = 5

# Fichier de sauvegarde
DATA_FILE = "users_data.json"

# --- FONCTIONS SAUVEGARDE ---

def load_data():
    try:
        with open(DATA_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    except FileNotFoundError:
        return {}

def save_data(data):
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, indent=4)

user_data = load_data()

# --- EVENTS ---

@bot.event
async def on_ready():
    print(f"âœ¨ ConnectÃ© en tant que {bot.user}")

@bot.event
async def on_raw_reaction_add(payload):
    if payload.user_id == bot.user.id:
        return

    guild = bot.get_guild(payload.guild_id)
    member = guild.get_member(payload.user_id)
    if not member:
        return

    emoji = str(payload.emoji)
    today = str(date.today())
    user_id = str(payload.user_id)

    if user_id not in user_data:
        user_data[user_id] = {"lumes": 0}

    # --- PRIÃˆRES ---
    if emoji in PRIERES and payload.message_id in AUTEL_MESSAGES.values():
        if user_data[user_id].get("priere_date") == today:
            await member.send("ğŸŒ™ Tu as dÃ©jÃ  reÃ§u une bÃ©nÃ©diction aujourdâ€™hui.")
            return

        role_name = PRIERES[emoji]
        role = discord.utils.get(guild.roles, name=role_name)
        if role:
            await member.add_roles(role)
            user_data[user_id]["priere_date"] = today
            save_data(user_data)
            await member.send(f"âœ¨ Tu as reÃ§u la bÃ©nÃ©diction **{role_name}** !")
        return

    # --- OFFRANDES ---
    for dieu, emojis in OFFRANDES.items():
        if emoji in emojis and payload.message_id == AUTEL_MESSAGES[dieu]:
            if user_data[user_id].get("offrande_date") == today:
                await member.send("ğŸŒ™ Tu as dÃ©jÃ  fait une offrande aujourdâ€™hui.")
                return

            user_data[user_id]["lumes"] += LUMES_PAR_OFFRANDE
            user_data[user_id]["offrande_date"] = today
            save_data(user_data)

            await member.send(f"ğŸ’ Ton offrande a Ã©tÃ© acceptÃ©e par **{dieu}**. Tu reÃ§ois **+{LUMES_PAR_OFFRANDE} Lumes** !")
            return

# --- COMMANDES ---

@bot.command()
async def benediction(ctx):
    user_id = str(ctx.author.id)
    today = str(date.today())

    # VÃ©rifie si lâ€™utilisateur a priÃ© aujourdâ€™hui
    if user_data.get(user_id, {}).get("priere_date") == today:
        role_name = user_data[user_id].get("priere_role", "Inconnue")
        await ctx.send(f"âœ¨ {ctx.author.mention}, ta bÃ©nÃ©diction du jour est **{role_name}**.")
    else:
        await ctx.send(f"ğŸŒ™ {ctx.author.mention}, tu nâ€™as pas encore priÃ© aujourdâ€™hui.")

bot.run("TON_TOKEN_ICI")
